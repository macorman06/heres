import { AxiosError } from 'axios';
import { ApiError } from '../../../types';
import { IS_DEVELOPMENT } from '../config/apiConfig';
import { TokenManager } from '../../auth/tokenManager';

export class ErrorHandler {
  static handleError(error: AxiosError): ApiError {
    console.log('‚ö†Ô∏è [ErrorHandler] Procesando error:', error);

    if (!error.response) {
      console.error('‚ùå [ErrorHandler] Error sin respuesta (posible error de red)');
      return {
        message:
          import.meta.env.MODE === 'localhost'
            ? 'Error de conexi√≥n. ¬øEst√° corriendo la API local?'
            : 'Error de conexi√≥n. Verifica tu conexi√≥n a internet.',
        status: 0,
      };
    }

    const status = error.response.status;
    const data = error.response.data as never;

    console.log('‚ö†Ô∏è [ErrorHandler] Error HTTP:', { status, data });

    switch (status) {
      case 400:
        console.log('‚ö†Ô∏è [ErrorHandler] 400 Bad Request');
        return {
          message: 'Datos inv√°lidos',
          status,
          details: data,
        };

      case 401:
        console.log('üî¥ [ErrorHandler] 401 Unauthorized - Limpiando auth');
        TokenManager.clearAuth();
        return {
          message: 'No autorizado. Por favor, inicia sesi√≥n nuevamente.',
          status,
          details: data,
        };

      case 403:
        console.log('‚ö†Ô∏è [ErrorHandler] 403 Forbidden');
        return {
          message: 'No tienes permisos para realizar esta acci√≥n.',
          status,
          details: data,
        };

      case 404:
        console.log('‚ö†Ô∏è [ErrorHandler] 404 Not Found');
        return {
          message: 'Recurso no encontrado.',
          status,
          details: data,
        };

      case 500:
        console.log('‚ùå [ErrorHandler] 500 Internal Server Error');
        return {
          message: IS_DEVELOPMENT
            ? 'Error del servidor. Revisa los logs de la API.'
            : 'Error interno del servidor. Int√©ntalo m√°s tarde.',
          status,
          details: data,
        };

      default:
        console.log('‚ö†Ô∏è [ErrorHandler] Error desconocido:', status);
        return {
          message: 'Error desconocido',
          status,
          details: data,
        };
    }
  }
}
